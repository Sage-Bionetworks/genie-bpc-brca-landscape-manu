---
title: "Predictive Survival"
subtitle: "Metastatic cohort, drugs grouped by class"
author: "Alex Paynter"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, include = F,
                      fig.width = 7, fig.height = 5,
                      warning = F, message = F)
```



```{r}
library(fs)
library(purrr)
library(here)
purrr::walk(.x = fs::dir_ls(here("R")), .f = source)
```

```{r}
dft_drug_feas_sum <- readr::read_rds(
  here('data', 'clin_data_cohort',
       'drug_feas_surv_dmet_sum.rds')
)

dft_drug_feas <- readr::read_rds(
  here('data', 'clin_data_cohort', 
       'drug_feas_surv.rds')
)

```


## Required conditions

Our goal is analyzing gene features that are predictive biomarkers for select drug classes in the population of metastatic cancer patients.  To make my life easier I will define a few time variables:

- M: The time from diagnosis to diagnosis of distant metastasis.
- D: The first use of the drug class in question for the participant.
- X: The time of the first next-generation sequencing test result for the participant (aka truncation time).
- Y: The censoring or event time for the event of interest (PFS I+M or OS).

I am considering the following conditions required for a record to be included in the analysis:

- **M≤D**.  Metastatic diagnosis happens before/on the first use of the drug.
- **X≤D**.  The drug start must be after/on the date of the sequencing test result (otherwise the drug causing the genomic result is a plausible explanation).
- **X≤Y**.  The sequencing test must be back before death/event/censoring - not always true in GENIE.

Our key first question is how many records that leaves us with for analysis.

## Eligible cohort sizes

The following table states the number of participants we have who took the drug at any point in the metastatic cohort (n_used_agent) and the number who could be included in an analysis of overall survival based on the time requirements outlined above (n_os).

```{r, include = T}
dft_drug_feas_sum %>%
  rename(` ` = class_comp) %>%
  flextable(.) %>%
  autofit(.)
```

Observations:

- Some of these drug classes are probably too small to do a robust analysis on.
- The number of people who used a drug is poorly related to the number who could be included in an analysis.


```{r}
dfp_pfs_feas_sum <- dft_drug_feas %>% 
  filter(had_met & crit_all_os) %>%
  mutate(
    # Use a tolerance of 0.001 yrs = 0.3 days here to avoid rounding erros.
    drug_after_reg = abs(
      drug_dx_start_int_yrs - dx_reg_start_int_yrs
    ) > 0.001,
    prog_before_drug = tt_reg_pfs_i_and_m_dx_yrs < drug_dx_start_int_yrs
  ) %>%
  group_by(class_comp) %>%
  summarize(
    n_elig = n(),
    n_drug_after_reg = sum(drug_after_reg),
    n_prog_before_drug = sum(prog_before_drug),
    n_problem = sum(prog_before_drug & drug_after_reg)
  )
```




```{r, eval = F}

```


## PFS feasibility

Our dataset contains derived variables for survival from start of drug regimen for those that have metastases.  Because we're interested in indexing from select drugs, rather than the regimen containing that drug, these is potentially an issue in using these variables for our analyses.  Specifically, if the following conditions are both met for any subjects meeting inclusion criteria for an analysis, we would have a problem:

1. The drug date and regimen date are not the same (drug should be later).
2. A progression event is noted for the regimen before the drug is started.

In this case we would not have access to the time from drug start to progression without recalculation of the variable.  Removing participants who meet these criteria from the analysis has an obvious bias potential by filtering out people with systematically low progression times.

We will start by simply calculating the number of people who meet these criteria (`n_problem`):

```{r}
dfp_pfs_feas_sum %>%
  rename(` ` = class_comp) %>%
  flextable(.) %>%
  autofit(.)
```

**Observations:**

- For all drugs except CDK inhibitors and IC inhibitors there are no people who meet both criteria.  Therefore, we should be fine to use the regimen progression variables (recalculated from drug start) in place of variables that index specifically from the drug start time.
-  


*Sidenote:*  Two long term fixes for this issue, to allow calculation of PFS from the start of a particular drug, include (1) adding PFS variables for each drug or (2) making the code used to gather PFS events available.  The latter has the advantage of extending to other types of events.



## Example analysis

Here we index from the time of first drug initiation.  Originally the plan was to look at anti-HER2 therapy, but as we can see from the table above the group that's eligible for anti-HER2 therapy is small.  I decided to use CDK inhibitors as a proof-of-concept instead.

Essentially we're applying similar methods here as we did with prognostic variables from the diagnosis of distant metastasis:  Bootstrapping a regularized cox model, and calling the number of bootstrap resamples where a covariate was selected 'stability'.  The main difference here is we don't have left truncation, because we index from drug iniation and filter our cohort based on the additional criteria above.

As a proof of concept, here are the results for CDK inhibitors (no clinical adjustments to start - need to think about these):

```{r}
dft_coef_cdk <- readr::read_rds(
  here('data', 'survival', 'drug', 'fit_outputs', 'fit_summary', 'coef_cdk.rds')
)
```

```{r, include = T}
plot_hr_rel_scatter_gene_clin(
  dft_coef_cdk,
  plot_title = "Varibles predictive of OS from first initiation of CDK inhibitors",
  plot_subtitle = "Limitations: metastatic patients whose first drug use is after at least one sequencing test."
)
```


