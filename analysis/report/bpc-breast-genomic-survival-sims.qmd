---
title: "GENIE BPC simulation"
format: beamer
execute:
  echo: false
  include: false
  message: false
  warning: false
  fig-height: 4
  fig-width: 6
execute-dir: project
---


```{r}
library(fs); library(here); library(purrr)
purrr::walk(.x = fs::dir_ls(here('R')), .f = source)
```

```{r}
pal_vib <- khroma::color("vibrant")
```


```{r}
sim_sum_all <- readr::read_rds(
  file = here('sim', 'combined_evals', 'sim_sum_all.rds')
)
sim_sum_avg <- readr::read_rds(
  file = here('sim', 'combined_evals', 'sim_sum_avg.rds')
)
```


```{r}
#| include: true

gg_abs_bias <- plot_one_sim_metric(
  dat_sim_all = sim_sum_all,
  dat_sim_avg = sim_sum_avg,
  x_var = "avg_abs_bias",
  x_lab = "Average absolute bias (one point = one sim)"
)

gg_bias <- plot_one_sim_metric(
  dat_sim_all = sim_sum_all,
  dat_sim_avg = sim_sum_avg,
  x_var = "avg_bias",
  x_lab = "Average bias (one point = one sim)"
)

gg_abs_bias_no_cox <- plot_one_sim_metric(
  dat_sim_all = filter(
    sim_sum_all, 
    !(analysis_method_f %in% "univar. Cox models")
  ),
  dat_sim_avg = filter(
    sim_sum_avg,
    !(analysis_method_f %in% "univar. Cox models")
  ),
  x_var = "avg_abs_bias",
  x_lab = "Average absolute bias (one point = one sim)"
)

gg_bias_no_cox <- plot_one_sim_metric(
  dat_sim_all = filter(
    sim_sum_all, 
    !(analysis_method_f %in% "univar. Cox models")
  ),
  dat_sim_avg = filter(
    sim_sum_avg,
    !(analysis_method_f %in% "univar. Cox models")
  ),
  x_var = "avg_bias",
  x_lab = "Average bias (one point = one sim)"
)
```



## Bias

```{r}
#| include: true

cowplot::plot_grid(
  gg_bias,
  gg_abs_bias,
  ncol = 1
)
```

## Bias (univariate excluded)

```{r}
#| include: true

cowplot::plot_grid(
  gg_bias_no_cox,
  gg_abs_bias_no_cox,
  ncol = 1
)
```



```{r}
gg_abs_bias_auc <- ggplot(
  data = sim_sum_all,
  aes(
    x = auc, 
    y = avg_abs_bias, 
    color = analysis_method_f
  )
) + 
  geom_point(alpha = 0.05) +   
  geom_point(
    data = sim_sum_avg,
    size = 5, stroke = 1, alpha = 1, shape = 4
  ) +
  facet_wrap(vars(n_lab)) + 
  theme_bw() + 
  scale_color_vibrant() +
  theme(
    legend.position = "bottom"
  )
```

## Bias vs AUC

```{r}
#| include: true
gg_abs_bias_auc
```




