---
title: "Survival from metastasis"
output: beamer_presentation
date: "2023-07-24"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, include = F,
                      fig.width = 7, fig.height = 5,
                      warning = F, message = F)
```

## Setup

Characteristics of the data:

- This cohort deals with non-Sarcoma breast cancer cases (n=~1100) 
- While the cohort contains data from all stages, we will index from the date of metastasis here.
- Secondary use data, curated from medical records using a common data model.
- Multi-site, technically international but overwhelmingly from the east coast US.
- Participants enter the cohort (are curated) only if they have a second-generation sequencing test result.  

## Analysis

- Goal:  Assessing whether there are features which are prognostic for overall survival from metastasis.  There is a special interest in genetic features.
- Features:
  - Genetic:  Binary indicators for mutations, copy number alterations and fusions for about 150 genes which are common to all sequencing panels in the cohort.
  - Clinical:  Demographics, stage at diagnosis, etc.
-


## Changes

- Added stratified survival estimates for hormonal subtype.
- Fixed a bug causing some participants with de novo metastasis to be eliminated from the analysis.
- Added some KM plots for a handful of reliably identified features.
- **Question:** Should we use the NGS order time rather than the report time for our marker of cohort entry?  It appears to be complete in this cohort, so I don't see why would not.
- Upcoming change:  Apply the gene frequency filters for each strata, not overall.  I am not expecting major result changes.

```{r}
library(fs)
library(purrr)
library(here)
purrr::walk(.x = fs::dir_ls(here("R")), .f = source)
```

```{r}
# Load all the fitted models from each bootstrap resample.
boot_models_dmet_all <- readr::read_rds(
  here("data", "survival", "fit_outputs", "fit_dmet_all.rds")
)
boot_models_dmet_trip_neg <- readr::read_rds(
  here("data", "survival", "fit_outputs", "fit_dmet_trip_neg.rds")
)
boot_models_dmet_hr_pos_her2_neg <- readr::read_rds(
  here("data", "survival", "fit_outputs", "fit_dmet_hr_pos_her2_neg.rds")
)
boot_models_dmet_her2_pos <- readr::read_rds(
  here("data", "survival", "fit_outputs", "fit_dmet_her2_pos.rds")
)



# Can replace these once you go back and fix the survival function creator:
dft_dmet_surv_all <- readr::read_rds(
  file = here('data', 'survival', 'prepared_data', 'surv_dmet_all.rds')
)
dft_dmet_surv_trip_neg <- readr::read_rds(
  file = here('data', 'survival', 'prepared_data', 'surv_dmet_trip_neg.rds')
)
dft_dmet_surv_hr_pos_her2_neg <- readr::read_rds(
  file = here('data', 'survival', 'prepared_data', 'surv_dmet_hr_pos_her2_neg.rds')
)
dft_dmet_surv_her2_pos <- readr::read_rds(
  file = here('data', 'survival', 'prepared_data', 'surv_dmet_her2_pos.rds')
)

```


```{r}
boot_models_dmet_trip_neg %>% glimpse

coef_helper <- function(dat) {
  dat %<>%
    mutate(
      coef_est = purrr::map(
        .x = fit,
        .f = (function(f) resample_coef_helper(f))
      )
    )
}

resample_coef_helper(boot_models_dmet_all)

```


# Results


```{r}

resample_dmet_wrap <- function(dat) {
  resample_coef_helper(
    dat = dat,
    exp_coefs = T,
    estimate_col_rename = "hr" # in other words, don't rename at all.
  )
}
dft_coef_dmet_os_all <- resample_dmet_wrap(
  dat = boot_models_dmet_all
)
dft_coef_dmet_os_trip_neg <- resample_dmet_wrap(
  dat = boot_models_dmet_trip_neg
)
dft_coef_dmet_os_hr_pos_her2_neg <- resample_dmet_wrap(
  dat = boot_models_dmet_hr_pos_her2_neg
)
dft_coef_dmet_os_her2_pos <- resample_dmet_wrap(
  dat =boot_models_dmet_her2_pos
)

gg_rel_scatter_os_all <- plot_hr_rel_scatter(
  dft_coef_dmet_os_all,
  plot_title = "OS prognostic variables from distant metastasis",
  plot_subtitle = "Reliability is the frequency of identification in a boostrapped regularized LTRC Cox model"
)

gg_rel_scatter_os_trip_neg <- plot_hr_rel_scatter(
  dft_coef_dmet_os_trip_neg,
  plot_title = "OS prognostic variables from distant metastasis (triple negative subgroup)",
  plot_subtitle = "Reliability is the frequency of identification in a boostrapped regularized LTRC Cox model"
)

gg_rel_scatter_os_hr_pos_her2_neg <- plot_hr_rel_scatter(
  dft_coef_dmet_os_hr_pos_her2_neg,
  plot_title = "OS prognostic variables from distant metastasis (HR+/HER2- subgroup)",
  plot_subtitle = "Reliability is the frequency of identification in a boostrapped regularized LTRC Cox model"
)
  
gg_rel_scatter_os_her2_pos <- plot_hr_rel_scatter(
  dft_coef_dmet_os_her2_pos,
    plot_title = "OS prognostic variables from distant metastasis (HER2+ subgroup)",
  plot_subtitle = "Reliability is the frequency of identification in a boostrapped regularized LTRC Cox model"
)
```


---

```{r, include = T}
gg_rel_scatter_os_all
```


```{r}
binary_helper <- function(vec, zero = "Wild Type", one = "Altered") {
  case_when(
    vec %in% 0 ~ zero,
    vec %in% 1 ~ one,
    T ~ "error"
  ) %>%
    factor(., levels = c(zero, one))
}

gg_surv_dmet_all_tp53_mut <- dft_dmet_surv_all %>%
  mutate(TP53_mut = binary_helper(TP53_mut)) %>%
  plot_km_dmet_binary_strata(
    dat = .,
    strata = "TP53_mut"
  )

gg_surv_dmet_all_ERBB2_cna <- dft_dmet_surv_all %>%
  mutate(ERBB2_cna = binary_helper(ERBB2_cna)) %>%
  plot_km_dmet_binary_strata(
    dat = .,
    strata = "ERBB2_cna"
  )

gg_surv_dmet_all_stage_iv <- dft_dmet_surv_all %>%
  mutate(stage_dx_iv_num = binary_helper(
    stage_dx_iv_num,
    zero = "Stage I-III at dx",
    one = "Stage IV at dx")
  ) %>%
  plot_km_dmet_binary_strata(
    dat = .,
    strata = "stage_dx_iv_num"
  )
```



---

```{r, include = T}
gg_surv_dmet_all_tp53_mut
```

---

```{r, include = T}
gg_surv_dmet_all_ERBB2_cna
```

---

```{r, include = T}
gg_surv_dmet_all_stage_iv
```




---

```{r, include = T}
gg_rel_scatter_os_hr_pos_her2_neg
```

```{r, include = T}
gg_surv_dmet_hr_pos_her2_neg_1 <- dft_dmet_surv_hr_pos_her2_neg %>%
  mutate(TP53_mut = binary_helper(TP53_mut)) %>%
  plot_km_dmet_binary_strata(
    dat = .,
    strata = "TP53_mut"
  )

gg_surv_dmet_hr_pos_her2_neg_2 <- dft_dmet_surv_hr_pos_her2_neg %>%
  mutate(DNMT3A_mut = binary_helper(DNMT3A_mut)) %>%
  plot_km_dmet_binary_strata(
    dat = .,
    strata = "DNMT3A_mut"
  )

gg_surv_dmet_hr_pos_her2_neg_3 <- dft_dmet_surv_hr_pos_her2_neg %>%
  mutate(MYC_cna = binary_helper(MYC_cna)) %>%
  plot_km_dmet_binary_strata(
    dat = .,
    strata = "MYC_cna"
  )

```



---

```{r, include = T}
gg_surv_dmet_hr_pos_her2_neg_1
```

---

```{r, include = T}
gg_surv_dmet_hr_pos_her2_neg_2
```

---

```{r, include = T}
gg_surv_dmet_hr_pos_her2_neg_3
```

---

```{r, include = T}
gg_rel_scatter_os_her2_pos
```


```{r, include = T}
gg_surv_dmet_her2_pos_1 <- dft_dmet_surv_her2_pos %>%
  mutate(ERBB2_cna = binary_helper(ERBB2_cna)) %>%
  plot_km_dmet_binary_strata(
    dat = .,
    strata = "ERBB2_cna"
  )

```

---

```{r, include = T}
gg_surv_dmet_her2_pos_1
```



---

```{r, include = T}
gg_rel_scatter_os_trip_neg
```

```{r, include = T}
gg_surv_dmet_trip_neg <- dft_dmet_surv_trip_neg %>%
  mutate(MYCL_cna = binary_helper(MYCL_cna)) %>%
  plot_km_dmet_binary_strata(
    dat = .,
    strata = "MYCL_cna"
  )

```






```{r}
dft_coef_combined <- bind_rows(
  mutate(dft_coef_dmet_os_all, strata = "All"),
  mutate(dft_coef_dmet_os_trip_neg, strata = "Triple Negative"),
  mutate(dft_coef_dmet_os_hr_pos_her2_neg, strata = "HR+/HER2-"),
  mutate(dft_coef_dmet_os_her2_pos, strata = "HER2+")
) %>%
  filter(stability > 0.3) %>%
  mutate(strata = forcats::fct_inorder(strata))
```

---

```{r, include = T}
plot_hr_forest_multi(dft_coef_combined, strat_var = "strata") + 
  labs(title = "Features with over 30% stability over all models")
```

