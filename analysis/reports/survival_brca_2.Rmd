---
title: "Survival BrCa"
author: "Alex Paynter"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, include = F,
                      message = F, warning = F)
```

```{r}
library(cli) # prevents an error on version reliance.
library(readr)
library(vctrs)
library(rlang)
library(here)
library(dplyr)
library(tidyr)
library(stringr)
library(magrittr)
library(tibble)
library(janitor)
library(glue)
library(ggplot2)
library(flextable)
library(officer)
library(cfmisc) # https://github.com/alexpaynter/cfmisc/

library(survival)
# library(survminer) # hard pass.
library(ggsurvfit)
library(tranSurv)

purrr::walk(
  .x = here("R", dir(here("R"))), 
  .f = source
)
```

```{r,load_data}
# Can later be combined with the other survival analysis script.
dft_surv <- readr::read_rds(
  here("data", "surv_dat.rda")
)

dft_surv %>% 
  mutate(pfs_miss = is.na(tt_pfs_i_and_m_adv_yrs)) %>%
  tabyl(pfs_miss)

```

<style type="text/css">
.main-container {
  max-width: 800px !important;
  margin: auto;
}
</style>

## Terms

- **Delayed cohort entry** or **truncation** both refer to the time of genomic (NGS) sequencing.  This is delayed in our study because participants are only curated at the time of NGS, which is often long after diagnosis of disease.
- **Dependent** truncation refers to when the failure time (e.g., death for overall survival) is associated with the time of cohort entry (NGS).

## Truncation dependence

We expect delayed cohort entry in our study based on Kehl, 2020 (10.1001/jamanetworkopen.2020.6976) and the setup in GENIE BPC.  To test this in our data we will use the estimator of Kendall's conditional tau statistic proposed by Martin and Betensky, 2005 (https://doi.org/10.1198/016214504000001538).  The IPW estimators proposed by Austin and Betensky, 2014 (doi:10.1016/j.csda.2013.11.018.) were found to have lower power for detecting dependent truncation, so we won't use those more complex estimators here.

The following table shows estimates of conditional Kendall's tau.  A nonzero estimate indicates that delayed cohort entry (dependent truncation) was detected.  A negative estimate indicates that long times to sequencing (entry) are associated with short survival times, both relative to diagnosis.

```{r}
# While the Martin and Betensky estimators will be used
#  for confirming dependent cohort entry, we will calculate
#  some other options here to anticipate questions which
#  may arise.

dft_cken <- expand_grid(
  fail = c("tt_os_dx_yrs"),
  method = c("MB", "IPW1", "IPW2")
) %>%
  mutate(
    trunc = "dx_cpt_rep_yrs",
    event = case_when(
      fail %in% "tt_os_dx_yrs" ~ "os_dx_status",
      T ~ NA_character_ 
    )
  ) %>%
  select(trunc, fail, event, method)

dft_cken %<>%
  mutate(
    ckd = purrr::pmap(
      .l = list(t = trunc,
                f = fail,
                e = event,
                m = method),
      .f = (function(t,f,e,m) {
        cken_help(dat = dft_surv,
                  trunc = t,
                  fail = f,
                  event = e,
                  method = m,
                  ci = T)
      })
    )
  ) %>%
  unnest(ckd)

dfp_cken <- dft_cken %>%
  mutate(
    `Cond. Tau` = cfmisc::est_int_str(
      est = est, 
      lower = lcb,
      upper = ucb,
      est_digits = 2
    ),
    `P Value` = pval_nejm(p = p_value)
  ) %>%
  select(`Cond. Tau`, `P Value`, Method = method)
```


```{r, include = T}
dfp_cken %>%
  flextable(.) %>%
  autofit(.) %>%
  color(i = ~Method %in% "MB", color = "black") %>%
  color(i = ~!(Method %in% "MB"), color = 'gray60')
```

## Whole cohort survival

### Transformation model

```{r}
surv_obj_os_tm <- with(
  dft_surv,
  trSurvfit(
    trun = dx_cpt_rep_yrs,
    obs = tt_os_dx_yrs,
    delta = os_dx_status
  )
)

surv_obj_os_tm # interesting for what they output.

dft_surv_os_tm <- surv_obj_os_tm$surv %>% 
  as_tibble %>%
  rename_all(tolower)

# Amazing:  confirmed below that this wildly different KM
# fit is risk set adjusted - in other words it matches
# what I did with ggsurvfit() below.

surv_obj_os_tm$surv

plot(surv_obj_os_tm)


```


### Risk time adjustment model

Risk time adjustment assumes independent censoring, which we suspect and have tested to be false.  However, it is still by far the most common model used for truncated survival, so it provides an important comparison.

```{r}
surv_obj_os <- with(
  dft_surv,
  Surv(
    time = dx_cpt_rep_yrs,
    time2 = tt_os_dx_yrs,
    event = os_dx_status)
)


# fit_os <- survfit(surv_obj_os ~ 1, data = dft_surv)

surv_pal <- c('#bb5566', '#004488', '#ddaa33')

gg_os <- survfit2(surv_obj_os ~ 1, data = dft_surv) %>%
  ggsurvfit(color = surv_pal[1]) +
  geom_step(data = dft_surv_os_tm, 
            inherit.aes = F,
            aes(x = time, y = trsurv),
            color = 'forestgreen') + 
  add_risktable(
    risktable_stats = c(
      "n.risk",
      "cum.censor",
      "cum.event"
    )
  ) +
  # too many:
  # add_censor_mark(alpha = 0.1,
  #                 shape = 4,
  #                 size = 2,
  #                 color = surv_pal[3]) +
  add_quantile(y_value = 0.5,
               linetype = 1,
               alpha = 0.5,
               size = 1,
               color = surv_pal[2]) + 
  # these two scale calls are a manual version 
  #   of scale_ggsurvfit()
  # Except that we moved the limits to coord_cartesian
  # to avoid clipping.
  scale_y_continuous(
    expand = c(0,0), 
    label = scales::label_percent()
  ) + 
  scale_x_continuous(
    name = "Years from cancer diagnosis",
    expand = c(0.025,0),
    breaks = seq(0, 100, by = 2.5)
  ) + 
  coord_cartesian(
    xlim = c(0, NA),
    ylim = c(0,1)
  ) + 
  labs(title = "Overall survival") + 
  theme(
    axis.title.y = element_blank()
  )


# This is ewwwy.
# gg_os <- ggsurvplot(
#   fit = fit_os,
#   data = dft_surv,
#   conf.int = F,
#   risk.table = "absolute",
#   ncensor.plot = T,
#   cumevents = T,
#   cumcensor = T,
#   surv.plot.height = 1,
#   risk.table.height = 0.1, # default
#   ncensor.plot.height = 0.1,
#   nevent.plot.height = 0.1,
#   surv.median.line = "hv",
#   xlab = "Years from diagnosis",
#   ylab = "Survival",
#   break.x.by = 5,
#   tables.theme = 
#     theme_cleantable(
#       base_size = 8,
#       font.main = c(8, "plain", "black"),
#       font.y = c(8, "plain", "white")
#     )
# )



```


```{r, include = T, fig.width = 7, fig.height = 5}
gg_os
```











## Bivariate time distribution plots

```{r, include = T}
ggplot(dft_surv,
       aes(
         x = tt_pfs_i_and_m_adv_yrs,
         y = tt_os_dx_yrs
       )) + 
  geom_point() +
  coord_equal()

ggplot(dft_surv,
       aes(
         x = dx_cpt_rep_yrs,
         y = tt_pfs_i_and_m_adv_yrs
       )) + 
  geom_point() +
  coord_equal()

ggplot(dft_surv,
       aes(
         x = dx_cpt_rep_yrs,
         y = tt_os_dx_yrs
       )) + 
  geom_point() +
  coord_equal()



```
         
