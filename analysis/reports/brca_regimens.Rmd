---
title: "BrCa Regimens"
author: "Alex Paynter"
date: "2023 Apr 17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, include = F,
                      message = F, warning = F)
```

```{r}
library(cli) # prevents an error on version reliance.
library(readr)
library(vctrs)
library(rlang)
library(here)
library(dplyr)
library(tidyr)
library(stringr)
library(magrittr)
library(janitor)
library(glue)
library(genieBPC)
library(ggplot2)
library(sunburstR)
library(huxtable)

purrr::walk(.x = here("R", dir(here("R"))), .f = source)
```


```{r}
data_list <- readr::read_rds(here("data-raw", "data_list.rds"))

# Selects the first index cancer for participants who have more than one.
# Reasons are:
#   (1) the sunburst plot code won't run correctly with duplicates.
#   (2) there's an obvious strong correlation problem in using two cancers
#       from one person.
data_list$BrCa_v1.2$ca_dx_index <- data_list$BrCa_v1.2$ca_dx_index %>%
  group_by(record_id) %>% 
  slice(1) %>%
  ungroup

```

```{r}
# need this 
pt_pfs_m <- get_progressed_timing(
  ca_dat = data_list$BrCa_v1.2$ca_dx_index,
  prefix = "pfs_m_adv"
)
prog_cohort <- filter_dl_by_pt(data_list,
                               pt_pfs_m)

```

## Introduction

This documents shows a few outputs for the breast cancer (BrCa) BioPharma Collaborative (BPC) cohort for AACR project GENIE.  The goal is to facilitate further discussion.

We left the meeting in early April with an interest in looking at medications administered after a progression or recurrence or worsening of disease.  This could take a few forms in the BPC data:

- Regimens started at or after progression by medical oncologist notes.
- Regimens started at or after progression by imaging.
- And/or combinations of medical oncologist note and imaging.
- Regimens started after distant metastases were noted.
- Regimens started after after a period of no cancer, followed by a return of cancer later on (recurrence).

For today we've created some outputs for the first option, regimens started at or after progression by medical oncologist note.  Participants whose death signified the progression are excluded.

```{r}
n_brca <- nrow(data_list$BrCa_v1.2$pt_char)
pct_of_cohort <- function(n, d = n_brca) {
  glue("{n} ({formatC(round(n/d*100,1), format = 'f', digits = 1)}%)")
}

n_prog_7d <- pt_pfs_m %>% filter(tt_d <= 7) %>% nrow %>% pct_of_cohort
n_prog_30d <- pt_pfs_m %>% filter(tt_d <= 30) %>% nrow %>% pct_of_cohort

```

It should be noted that progression was quick in this cohort and this may be an excessively loose criterion to give meaningful answers.  For example, `n_prog_7d` had progressed by 7 days after diagnosis and `n_prog_30d` had progressed by 30 days after diagnosis.


## Sunburst plot

The following sunburst plot shows the first two regimens patients started on or after a progression was noted by medical oncologist.

```{r}
prog_sun_obj <- genieBPC::drug_regimen_sunburst(
  data_list$BrCa_v1.2[c("pt_char", "ca_dx_index", "ca_drugs", "cpt")],
  prog_cohort,
  max_n_regimens = 2
)

set.seed(37) # for color sampling.
# turbo but avoiding the highlighter green.
sun_pal <- sample(
  c(
    viridisLite::turbo(n = nrow(prog_sun_obj$treatment_history)/2,
                       begin = 0.05, end = 0.35),
    viridisLite::turbo(n = nrow(prog_sun_obj$treatment_history)/2,
                       begin = 0.6, end = 0.95)
  )
)
sun_prog_med_onc <- sunburstR::sunburst(
  prog_sun_obj$treatment_history,
  legend = F,
  colors = sun_pal
)
```
```{r, include = T}
sun_prog_med_onc
```

Shows the first two regimens patients started on or after a progression was noted by medical oncologist.








```{r}
# get a 1-row-per-drug dataset:
dft_drug <- prog_cohort$cohort_ca_drugs %>% 
  select(cohort:redcap_ca_index,
         drugs_drug_1:drug_start_end_or_lastadm_int_5) %>%
  mutate(across(
    c(contains("drugs_drug_"), drugs_admin),
    .fn = ~ vec_cast(.x, to = "character"))
  ) %>%
  mutate(
    across(
      .cols = drugs_startdt_int_1:drug_start_end_or_lastadm_int_5,
      .fns = as_double
    )
  )



# split off the character values, we'll do those separately
#   to avoid casting issues.
dft_drug_char <- dft_drug %>%
  select(record_id, regimen_number, 
         drugs_drug_1: drugs_drug_5)

dft_drug %<>%
  select(-contains("drugs_drug_")) %>%
  pivot_longer(
    cols = drugs_startdt_int_1:drug_start_end_or_lastadm_int_5,
    names_to = "var",
    values_to = "value"
  ) %>%
  # Because "drug_num" is confusing when we have "drugs_num" in 
  #   the raw data.
  # This is only an id for drug within regimen within person.
  mutate(drug_id = readr::parse_number(var),
         var = stringr::str_replace(var, "_[0-5]", "")) %>%
  pivot_wider(names_from = "var", values_from = "value") %>%
  select(record_id, contains("regimen_number"), drug_id, everything()) 

# Now do it again for the cluster of character columns.
#   All the previous ones were integer/double.
dft_drug_char %<>%
  pivot_longer(
    cols = drugs_drug_1: drugs_drug_5,
    names_to = "var",
    values_to = "value"
  ) %>%
  # Because "drug_num" is confusing when we have "drugs_num" in 
  #   the raw data.
  # This is only an id for drug within regimen within person.
  mutate(drug_id = readr::parse_number(var),
         var = stringr::str_replace(var, "_[0-5]", "")) %>%
  # because there is only one column we don't need to pivot here,
  #  just rename.
  select(record_id, regimen_number, drug_id, drug = value)

dft_drug <-
  left_join(dft_drug, dft_drug_char, 
            by = c("record_id", "regimen_number", "drug_id")) %>%
  relocate(drug, .before = drugs_startdt_int)

# empty rows here have no meaning - it's just regimens with less
#   than 5 drugs which is not suprising or interesting.
dft_drug %<>%
  filter(!is.na(drug))
```


```{r}


dfp_top_drugs <- dft_drug %>%
  group_by(record_id, drug) %>%
  summarize(observed = 1, .groups = "drop") %>%
  group_by(drug) %>%
  summarize(n = sum(observed)) %>%
  arrange(desc(n)) %>%
  head(10)

dc_wrap <- function(drug_name) {
  get_drug_compliments(dft_drug, drug_name) %>%
    reshape_drug_compliments()
}

dfp_top_drugs <- dfp_top_drugs %>%
  mutate(df_top_comp = purrr::pmap(
    .l = list(drug_name = drug),
    .f = dc_wrap
  )) %>%
  tidyr::unnest(df_top_comp) %>%
  mutate(drug = str_replace(drug, "\\(.*\\)", ""))
```

## Medications

The following table shows the drugs taken after a progression was noted, sorted by the number of participants who took them (n) in any regimen started on or after a progression.  

"Compliment 1" shows the drug most commonly administered in regimens using this row's drug.  "Compliment 2" shows the second most common.  

*Example interpretation using row 1 (may become incorrect with data updates):* Capecitabine was used by more participants (444) than any other drug.  Regimens containing capecitabine also frequently contained Trastuzumab (11.6%) and Lapatinib Ditosylate (7.6%)

```{r, include = T}
dfp_top_drugs %>% 
  select(Drug = drug, 
         n = n, 
         `Compliment 1` = first, 
         `Compliment 2` = second) %>%
  huxtable::hux(.) %>%
  theme_striped(.)
  
```



